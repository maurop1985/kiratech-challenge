---
# tasks file for docker-securitization
- name: "Generate CA, Server and Client Certificate"
  include_role:
    name: alexinthesky.secure-docker-daemon

- name: "Create docker.service.d directory"
  file:
    path: "/etc/systemd/system/docker.service.d"
    state: directory

- name: "Edit docker service configuration"
  copy:
    dest: "/etc/systemd/system/docker.service.d/override.conf"
    content: |
      [Service]
      ExecStart=
      ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2376 --tlsverify --tlscacert=/etc/docker/ca.pem --tlscert=/etc/docker/server-cert.pem --tlskey=/etc/docker/server-key.pem

- name: "Restart Docker"
  ansible.builtin.systemd:
    daemon_reload: yes
    name: docker
    state: restarted